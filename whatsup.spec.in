Name:    @PROJECT@
Version: @VERSION@
%if %{?_with_chaos:1}%{!?_with_chaos:0}
Release: @RELEASE@chaos
%else
Release: @RELEASE@
%endif
Summary: whatsup node up/down detection utility
Group: Applications/Communications
License: GPL
Source: @PROJECT@-@VERSION@-@RELEASE@.tgz
BuildRoot: %{_tmppath}/@PROJECT@-@VERSION@-@RELEASE@
%if %{?_with_chaos:1}%{!?_with_chaos:0}
Requires: gendersllnl
Requires: genders >= 1.4
Requires: cerebro >= 1.0-0pre5
%endif

%description
Whatsup is a cluster node up/down detection utility.

%if %{?_with_chaos:1}%{!?_with_chaos:0}
%define _with_cerebro      --with-cerebro
%define _with_gendersllnl  --with-gendersllnl
%define _without_genders   --without-genders
%define _without_hostsfile --without-hostsfile
%define _with_chaos_config --with-chaos-config
%else
%{!?_with_cerebro: %{!?_without_cerebro: %define _with_cerebro --with-cerebro}}
%{!?_with_gendersllnl: %{!?_without_gendersllnl: %define _with_gendersllnl --with-gendersllnl}}
%{!?_with_genders: %{!?_without_genders: %define _with_genders --with-genders}}
%{!?_with_hostsfile: %{!?_without_hostsfile: %define _with_hostsfile --with-hostsfile}}
%{!?_with_chaos_config: %{!?_without_chaos_config: %define _with_chaos_config --with-chaos-config}}
%endif

%package backend-ganglia
Summary: whatsup ganglia backend
Group: System Environment/Base
Requires: whatsup
%description backend-ganglia
Ganglia backend module

%package backend-cerebro
Summary: whatsup cerebro backend
Group: System Environment/Base
Requires: whatsup
Requires: cerebro
%description backend-cerebro
Cerebro backend module

%package clusterlist-gendersllnl
Summary: whatsup gendersllnl clusterlist module
Group: System Environment/Base
Requires: whatsup
Requires: gendersllnl
%description clusterlist-gendersllnl
Gendersllnl clusterlist module

%package clusterlist-genders
Summary: whatsup genders clusterlist module
Group: System Environment/Base
Requires: whatsup
Requires: genders >= 1.2
%description clusterlist-genders
Genders clusterlist module

%package clusterlist-hostsfile
Summary: whatsup hostsfile clusterlist module
Group: System Environment/Base
Requires: whatsup
%description clusterlist-hostsfile
Hostsfile clusterlist module

%package config-chaos
Summary: whatsup chaos config module
Group: System Environment/Base
Requires: whatsup
Requires: chaos
%description config-chaos
Chaos config module

%package options-gendersllnl
Summary: whatsup gendersllnl options module
Group: System Environment/Base
Requires: whatsup
Requires: gendersllnl
%description options-gendersllnl
Gendersllnl options module

%prep
%setup -q -n @PROJECT@-@VERSION@-@RELEASE@

%build
%configure --program-prefix=%{?_program_prefix:%{_program_prefix}} \
           --with-perl-install-destdir="$RPM_BUILD_ROOT" \
           %{?_with_cerebro} \
           %{?_without_cerebro} \
           %{?_with_gendersllnl} \
           %{?_without_gendersllnl} \
           %{?_with_genders} \
           %{?_without_genders} \
           %{?_with_hostsfile} \
           %{?_without_hostsfile} \
           %{?_with_chaos_config} \
           %{?_without_chaos_config}
make

%install
rm -rf "$RPM_BUILD_ROOT"
DESTDIR="$RPM_BUILD_ROOT" make install

%clean
rm -rf "$RPM_BUILD_ROOT"

%files
%defattr(-,root,root)
%doc AUTHORS COPYING ChangeLog DISCLAIMER INSTALL NEWS README README.expat 
# It doesn't matter if the user chooses a 32bit or 64bit target.  The
# packaging must work off whatever Perl is installed.
%define _perldir %(perl -e 'use Config; $T=$Config{installsitearch}; $T=~/(.*)\\/site_perl.*/; print $1;')
%{_bindir}/*
%{_includedir}/*
%if %{?_with_chaos:1}%{!?_with_chaos:0}
%{_libdir}/nodeupdown/*
%{_libdir}/whatsup/*
%endif
%{_libdir}/libnodeupdown.*
%{_perldir}/*
%{_mandir}/*

%if %{?_with_chaos:0}%{!?_with_chaos:1}

%files backend-ganglia
%defattr(-,root,root)
%{_libdir}/nodeupdown/*ganglia.*

%if %{?_with_cerebro:1}%{!?_with_cerebro:0}
%files backend-cerebro
%defattr(-,root,root)
%{_libdir}/nodeupdown/*cerebro.*
%endif

%if %{?_with_gendersllnl:1}%{!?_with_gendersllnl:0}
%files clusterlist-gendersllnl
%defattr(-,root,root)
%{_libdir}/nodeupdown/*clusterlist_gendersllnl.*
%endif

%if %{?_with_genders:1}%{!?_with_genders:0}
%files clusterlist-genders
%defattr(-,root,root)
%{_libdir}/nodeupdown/*genders.*
%endif

%files clusterlist-hostsfile
%defattr(-,root,root)
%{_libdir}/nodeupdown/*hostsfile.*

%if %{?_with_chaos_config:1}%{!?_with_chaos_config:0}
%files config-chaos
%defattr(-,root,root)
%{_libdir}/nodeupdown/*config_chaos.*
%endif

%if %{?_with_gendersllnl:1}%{!?_with_gendersllnl:0}
%files options-gendersllnl
%defattr(-,root,root)
%{_libdir}/whatsup/*gendersllnl.*
%endif
%endif
